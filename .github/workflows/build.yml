name: Build

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3

    - name: Restore cached kit
      id: cache-kit
      uses: actions/cache/restore@v3
      with:
        path: C:\islekit
        key: islekit

    - name: Download DX5 SDK
      if: steps.cache-kit.outputs.cache-hit != 'true'
      run: |
        curl -LO https://archive.org/download/idx5sdk/idx5sdk.exe
        7z x .\idx5sdk.exe
        7z x .\DX5SDK.EXE

    - name: Setup MSVC 4.20
      if: steps.cache-kit.outputs.cache-hit != 'true'
      run: |
        git clone --depth 1 https://github.com/itsmattkc/msvc420 c:\islekit\msvc420
        
    - name: Setup DX5 SDK
      if: steps.cache-kit.outputs.cache-hit != 'true'
      run: |
        move cdrom c:\islekit\dx5sdk

    - name: Cache kit
      if: steps.cache-kit.outputs.cache-hit != 'true'
      id: save-dx5
      uses: actions/cache/save@v3
      with:
        path: C:\islekit
        key: islekit

    - name: Build
      shell: cmd
      run: |
        set ISLE_KIT_ROOT=C:/islekit
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" amd64
        cmake -GNinja -Bbuild --toolchain cmake/Toolchain/msvc42.cmake -DCMAKE_BUILD_TYPE=Release
        cmake --build build -j 1
      
    - name: Upload Artifact
      uses: actions/upload-artifact@master
      with:
        name: Win32
        path: build/isle/isle.exe
